# 06｜正则表达式测试器：实时匹配与模板库

本篇聚焦 DevTools Hub 的“正则测试器”。我们从输入→匹配→高亮→分组展示→模板库，构建一个实用的正则工作台，并讨论若干性能与易用性陷阱。

## 1. UI 结构与交互流

- 模式输入：正则模式 + flags（g/i/m/s/u）
- 待测文本区：支持大文本
- 输出区：
  - 高亮所有匹配（g 模式下）
  - 列出每个匹配的捕获分组
  - 错误时清晰提示（如语法错误）

## 2. 编译与错误处理

```js
function buildRegex(pattern, flags) {
  try {
    return { regex: new RegExp(pattern, flags), error: null }
  } catch (e) {
    return { regex: null, error: e.message }
  }
}
```
- 错误时：
  - 高亮模式输入框
  - 在输出区展示错误信息
  - 不阻塞用户继续编辑

## 3. 匹配与高亮

- 使用 `regex.exec()` 迭代，或用 `String.prototype.matchAll`（带 g）
- 高亮策略：将原文本分片包裹 `<mark>` 或带类名的 `<span>`，注意转义 HTML
- 记得处理重叠匹配与零宽匹配（如 `^`、`$`、`\b`）

示意：
```js
function highlightAll(text, regex) {
  const matches = [...text.matchAll(regex)]
  let lastIndex = 0
  const parts = []
  for (const m of matches) {
    const [matched] = m
    parts.push(escapeHtml(text.slice(lastIndex, m.index)))
    parts.push(`<mark>${escapeHtml(matched)}</mark>`) // 高亮命中
    lastIndex = m.index + matched.length
  }
  parts.push(escapeHtml(text.slice(lastIndex)))
  return parts.join('')
}
```

## 4. 捕获分组与命名分组

- 对每个匹配输出 `m[i]` 与 `m.groups`（命名分组）
- 清晰的表格式展示：分组索引、内容、起止位置
- 未匹配的分组显示为空，避免让用户误解

## 5. 常用模板库

- 提供可点击模板（邮箱/URL/手机号/IPv4/日期等）
- 点击即填充 pattern 与 flags，并触发测试
- 将常用模板保存在常量或 JSON 中，便于增补

## 6. 性能与陷阱

- 大文本：节流/防抖处理输入事件，避免每键都重算
- 灾难性回溯：提示典型误用（如 `(a+)+`）
- 超长高亮：对超长文本仅展示前 N KB 的高亮预览，并在下方提供命中统计

## 7. 集成与体验

- 与导航深链接：`?tool=regex-tester`
- 键盘快捷键：Alt + 对应数字（参见第 2 篇）
- 复制匹配结果/分组为 JSON

## 8. 小练习

- 支持“仅显示匹配行”视图
- 命名分组重命名提醒（重复名称报错）
- 导出/导入模板库（JSON）

---

上一章：05-颜色调色板  ｜  下一章：07-PWA 进阶：缓存策略、离线页、更新与后台同步
